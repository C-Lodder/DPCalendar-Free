function checkOverlapping(){if(!(jQuery("#dp-event-form-message-box").length<1)){jQuery("#dp-event-form-message-box").hide();var e=jQuery("#dp-event-form").find("input[name!=task], select"),r=new Url;jQuery.ajax({type:"post",url:"index.php?option=com_dpcalendar&task=event.overlapping",data:e.serialize()+"&id="+r.query.e_id,success:function(e){var r=jQuery.parseJSON(e);if(null!=r.messages&&jQuery("#system-message-container").length&&Joomla.renderMessages(r.messages),r.data.message){var t=jQuery("#dp-event-form-message-box");t.show(),t.attr("class","alert "+(r.data.count?"":"alert-success")),t.html(r.data.message),jQuery(".save-button").attr("disabled",r.data.count>0)}}})}}function updateFormFromRule(){if(void 0!=jQuery("#jform_rrule").val()){var e=null;jQuery.each(jQuery("#jform_rrule").val().split(";"),function(){var r=this.split("=");if(r.length>1)switch(r[0]){case"FREQ":jQuery("#jform_scheduling input").each(function(){var t=jQuery(this);r[1]==t.val()&&(t.attr("checked","checked"),"0"==r[1]||(e=t.val())),"DAILY"==r[1]&&(jQuery("#jform_scheduling_daily_weekdays0").attr("checked",null),jQuery("#jform_scheduling_daily_weekdays1").attr("checked","checked"))});break;case"BYDAY":"WEEKLY"==e&&"MO,TU,WE,TH,FR"==r[1]&&(jQuery("#jform_scheduling_daily_weekdays0").attr("checked","checked"),jQuery("#jform_scheduling_daily_weekdays1").attr("checked",null),jQuery("#jform_scheduling1").attr("checked","Checked")),jQuery.each(r[1].split(","),function(){if("MONTHLY"==e){var r=this.length,t=this.substring(r-2,r),n=this.substring(0,r-2);-1==n&&(n="last"),jQuery('#jform_scheduling_monthly_week option[value="'+n+'"]').prop("selected",!0),jQuery('#jform_scheduling_monthly_week_days option[value="'+t+'"]').prop("selected",!0)}else jQuery('#jform_scheduling_weekly_days option[value="'+this+'"]').prop("selected",!0)});break;case"BYMONTHDAY":jQuery('#jform_scheduling_monthly_options input[value="by_day"]').attr("checked","checked"),jQuery.each(r[1].split(","),function(){jQuery('#jform_scheduling_monthly_days option[value="'+this+'"]').prop("selected",!0)});break;case"COUNT":jQuery("#jform_scheduling_repeat_count").val(r[1]);break;case"INTERVAL":jQuery("#jform_scheduling_interval").val(r[1]);break;case"UNTIL":var t=document.getElementById("jform_scheduling_end_date");t.value=moment.utc(r[1]).format(t.getAttribute("format"))}}),changeVisiblity()}}function updateRuleFromForm(){var e="";(jQuery("#jform_scheduling1")[0].checked&&(e="FREQ=DAILY",jQuery("#jform_scheduling_daily_weekdays0")[0].checked&&(e="FREQ=WEEKLY;BYDAY=MO,TU,WE,TH,FR")),jQuery("#jform_scheduling2")[0].checked)&&(e="FREQ=WEEKLY",(r=jQuery("#jform_scheduling_weekly_days option:selected")).length>0&&(e+=";BYDAY=",r.each(function(){e+=jQuery(this).val()+","}),e=e.slice(0,-1)));if(jQuery("#jform_scheduling3")[0].checked)if(e="FREQ=MONTHLY",jQuery("#jform_scheduling_monthly_options0")[0].checked){var r;(r=jQuery("#jform_scheduling_monthly_days option:selected")).length>0&&(e+=";BYMONTHDAY=",r.each(function(){e+=jQuery(this).val()+","}),e=e.slice(0,-1))}else{var t=jQuery("#jform_scheduling_monthly_week option:selected"),n=!1;t.length>0&&(e+=";BYDAY=",t.each(function(){var r=jQuery("#jform_scheduling_monthly_week_days option:selected");if(r.length>0){var t=jQuery(this).val();"last"==t&&(t=-1),r.each(function(){e+=t+jQuery(this).val()+",",n=!0})}}),n&&(e=e.slice(0,-1)))}if(jQuery("#jform_scheduling4")[0].checked&&(e="FREQ=YEARLY"),e.length>1){var a=jQuery("#jform_scheduling_interval").val();a>0&&(e+=";INTERVAL="+a);var i=jQuery("#jform_scheduling_repeat_count").val();i>0&&(e+=";COUNT="+i);var d=document.getElementById("jform_scheduling_end_date"),o=moment(d.value,d.getAttribute("format"));o.isValid()&&(e+=";UNTIL="+o.format("YYYYMMDD")+"T235900Z")}jQuery("#jform_rrule").val(e)}function updateLocationFrame(){if(jQuery("#jform_rooms").length<1)jQuery("#dp-event-form-map").hide();else{jQuery("#dp-event-form-map").detach().appendTo(jQuery("#jform_rooms").parent().parent().parent());var e=document.getElementById("dp-event-form-map-frame");null!=e&&null!=e.dpmap&&(DPCalendar.Map.clearMarkers(e.dpmap),jQuery("#jform_location_ids option:selected").each(function(){var r=jQuery(this).html(),t=r.substring(r.lastIndexOf("[")+1,r.lastIndexOf("]")).split(":");t.length<2||0==t[0]&&0==t[1]||DPCalendar.Map.createMarker(e.dpmap,{latitude:t[0],longitude:t[1],title:r})}))}}function changeVisiblity(){jQuery("#jform_scheduling0")[0].checked?(jQuery(".field-scheduling_end_date").parent().hide(),jQuery(".field-scheduling_interval").parent().hide(),jQuery(".field-scheduling_repeat_count").parent().hide(),jQuery(".field-rrule").parent().hide()):(jQuery(".field-scheduling_end_date").parent().show(),jQuery(".field-scheduling_interval").parent().show(),jQuery(".field-scheduling_repeat_count").parent().show(),jQuery(".field-rrule").parent().show()),jQuery("#jform_scheduling1")[0].checked?jQuery(".field-scheduling_daily_weekdays").parent().show():jQuery(".field-scheduling_daily_weekdays").parent().hide(),jQuery("#jform_scheduling2")[0].checked?jQuery(".field-scheduling_weekly_days").parent().show():jQuery(".field-scheduling_weekly_days").parent().hide(),jQuery("#jform_scheduling3")[0].checked?(jQuery(".field-scheduling_monthly_options").parent().show(),jQuery(".field-scheduling_monthly_week").parent().show(),jQuery(".field-scheduling_monthly_week_days").parent().show(),jQuery(".field-scheduling_monthly_days").parent().show(),jQuery("#jform_scheduling_monthly_options0")[0].checked?(jQuery(".field-scheduling_monthly_week").parent().hide(),jQuery(".field-scheduling_monthly_week_days").parent().hide(),jQuery(".field-scheduling_monthly_days").parent().show()):(jQuery(".field-scheduling_monthly_week").parent().show(),jQuery(".field-scheduling_monthly_week_days").parent().show(),jQuery(".field-scheduling_monthly_days").parent().hide())):(jQuery(".field-scheduling_monthly_options").parent().hide(),jQuery(".field-scheduling_monthly_week").parent().hide(),jQuery(".field-scheduling_monthly_week_days").parent().hide(),jQuery(".field-scheduling_monthly_days").parent().hide())}jQuery(document).ready(function(){if(jQuery(".field-scheduling, #jform_scheduling_monthly_options, #jform_scheduling_daily_weekdays").bind("click",function(e){changeVisiblity(),updateRuleFromForm()}),jQuery("#jform_scheduling_end_date, #jform_scheduling_interval, #jform_scheduling_repeat_count").bind("change",function(){updateRuleFromForm()}),jQuery("#jform_scheduling_weekly_days, #jform_scheduling_monthly_days, #jform_scheduling_monthly_week_days, #jform_scheduling_monthly_week").bind("change",function(){updateRuleFromForm()}),jQuery("#jform_rrule").bind("change",function(e){updateFormFromRule()}),updateFormFromRule(),jQuery("#scheduling-expert-button").click(function(){jQuery("#scheduling-rrule").children().fadeToggle()}),jQuery("#scheduling-rrule").children().hide(),jQuery("#jform_all_day input").bind("click",function(e){0==jQuery(this).val()?jQuery("#jform_start_date_time, #jform_end_date_time").show():jQuery("#jform_start_date_time, #jform_end_date_time").hide(),checkOverlapping()}),jQuery("#jform_all_day0")[0].checked||!jQuery("#jform_all_day0")[0].checked&&!jQuery("#jform_all_day1")[0].checked?jQuery("#jform_start_date_time, #jform_end_date_time").show():jQuery("#jform_start_date_time, #jform_end_date_time").hide(),jQuery("#jform_start_date, #jform_start_date_time, #jform_end_date, #jform_end_date_time").change(function(e){setTimeout(checkOverlapping,2e3)}),jQuery("#jform_catid").bind("change",function(e){return setTimeout(checkOverlapping,2e3),!0}),jQuery("#dp-event-form-message-box").hide(),setTimeout(checkOverlapping,2e3),setTimeout(updateLocationFrame,2e3),jQuery("#dp-event-form-container-tabs-tab-content").addClass("timepair"),Joomla.JText._("COM_DPCALENDAR_ONLY_AVAILABLE_SUBSCRIBERS")){jQuery(".field-scheduling .controls, #dp-event-form-container-tabs-tab-booking .controls").append('<span class="dp-event-form-free-information-text">'+Joomla.JText._("COM_DPCALENDAR_ONLY_AVAILABLE_SUBSCRIBERS")+"</span>")}jQuery("#jform_location_ids").bind("change",function(e){Joomla.loadingLayer("show"),jQuery("input[name=task]").val("event.reload"),this.form.submit()}),jQuery("#dp-event-form-map-form-save").click(function(){var e={jform:{title:jQuery("#location_title").val(),country:jQuery("#location_country").val(),province:jQuery("#location_province").val(),city:jQuery("#location_city").val(),zip:jQuery("#location_zip").val(),street:jQuery("#location_street").val(),number:jQuery("#location_number").val(),state:1,language:"*"}};e[jQuery("#dp-event-form-map-form-token").val()]="1",e.ajax="1",e.id=0,jQuery.ajax({type:"POST",url:"index.php?option=com_dpcalendar&task=locationform.save",data:e,success:function(e){var r=jQuery.parseJSON(e);null!=r.data.id&&null!=r.data.display&&(jQuery("#jform_location_ids").append('<option value="'+r.data.id+'" selected="selected">'+r.data.display+"</option>"),jQuery("#jform_location_ids").trigger("liszt:updated"),updateLocationFrame(),jQuery("#dp-event-form-map-form-container input").val("")),Joomla.renderMessages(r.messages)}})});var e=jQuery("#dp-event-form-map-form");e.hide(),jQuery("#dp-event-form-map-title-toggle-up").hide();var r=jQuery("#dp-event-form-map-title-toggle");r.bind("click",function(t){e.slideToggle("slow",function(){e.is(":visible")?(r.find('i[data-direction="up"]').show(),r.find('i[data-direction="down"]').hide()):(r.find('i[data-direction="up"]').hide(),r.find('i[data-direction="down"]').show())})})});